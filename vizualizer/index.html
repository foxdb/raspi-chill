<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Raspi Chill Temperature</title>
</head>

<body style="background-color: #EEEEEE">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script>
  <script src="https://momentjs.com/downloads/moment.min.js"></script>
  <div>
    <div style="margin: 20 80; padding: 20 80">
      <canvas id="lastHoursChart" width="400" height="200"></canvas>
      <br />
      <br />
      <canvas id="myChart" width="400" height="200"></canvas>
    </div>
  </div>
  <script>
    const DATE_FORMAT = 'YYYYMMDD_HH-mm-ss'
    fetch('https://8lcv9lzvgk.execute-api.ap-southeast-2.amazonaws.com/default/getTemperature-js', {
      // headers: { 'Content-Type': 'application/json' }
    }).then(res => {
      return res.json()
    }).then(data => {

      const findMinMax = (entries) => {
        let min = 100
        let max = 0
        entries.map(entry => {
          max = entry.temperature > max ? entry.temperature : max
          min = entry.temperature < min ? entry.temperature : min
        })
        return {
          min,
          max
        }
      }

      const lastHoursPoints = data.lastHours.map(entry => {
        return {
          x: moment(entry.date, DATE_FORMAT).format('HH:mm:ss'),
          y: entry.temperature
        }
      })

      const lastHoursMinMax = findMinMax(data.lastHours)

      const ctx2 = document.getElementById("lastHoursChart").getContext('2d');
      const lastHoursChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: lastHoursPoints.map(point => point.x),
          datasets: [{
            label: 'Air temperature',
            data: lastHoursPoints,
            borderWidth: 1,
            fill: false,
            borderColor: '#FF7E9D',
            backgroundColor: '#FFABBF'
          }]
        },
        options: {
          elements: { point: { radius: 0 } },
          responsive: true,
          title: {
            display: true,
            text: 'Latest 300 points ' + lastHoursPoints[0].x + ' - ' + lastHoursPoints.slice(-1)[0].x + ' - current temp: ' + lastHoursPoints.slice(-1)[0].y
          },
          tooltips: {
            mode: 'index',
            intersect: false,
          },
          hover: {
            mode: 'nearest',
            intersect: true
          },
          scales: {
            yAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Temperature'
              },
              ticks: {
                suggestedMin: lastHoursMinMax.min - 1,
                suggestedMax: lastHoursMinMax.max + 1,
              },
            }]


          }
        }
      });

      let minPoints = []
      let maxPoints = []
      let absoluteMin = 100
      let absoluteMax = 0
      let labels = []

      for (let i = 0; i < data.points.length; i = i + 100) {
        const subArray = data.points.slice(i, i + 100)

        let min = {
          y: 100
        }
        let max = {
          y: 0
        }

        subArray.map(entry => {
          if (entry.temperature > max.y) {
            max = { x: entry.date, y: entry.temperature }
            if (entry.temperature > absoluteMax) {
              absoluteMax = entry.temperature
            }
          }

          if (entry.temperature < min.y) {
            min = { x: entry.date, y: entry.temperature }
            if (entry.temperature < absoluteMin) {
              absoluteMin = entry.temperature
            }
          }
        })

        minPoints.push(min)
        maxPoints.push(max)
        labels.push(moment(subArray[0].date, DATE_FORMAT).format('MM-DD HH:mm'))
      }


      const ctx = document.getElementById("myChart").getContext('2d');
      const myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Minimum',
            data: minPoints,
            borderWidth: 1,
            fill: false,
            borderColor: '#4070FF',
            backgroundColor: '#3D8CFF'
          }, {
            label: 'Maximum',
            data: maxPoints,
            borderWidth: 1,
            fill: false,
            borderColor: '#FF7E9D',
            backgroundColor: '#FFABBF'
          }]
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: moment(data.points[0].date, DATE_FORMAT).format('D MMMM HH:mm')
              + ' - ' + moment(data.points.slice(-1)[0].date, DATE_FORMAT).format('D MMMM HH:mm')
              + ' - max: ' + data.maxTemp + ' - min: ' + data.minTemp
          },
          tooltips: {
            mode: 'index',
            intersect: false,
          },
          hover: {
            mode: 'nearest',
            intersect: true
          },
          scales: {
            xAxes: [{
              ticks: {
                suggestedMin: 0,
                // suggestedMax: 100
              },
              scaleLabel: {
                display: true,
                labelString: 'Time'
              }
            }],
            yAxes: [{
              ticks: {
                suggestedMin: absoluteMin - 3,
                suggestedMax: absoluteMax + 3,
              },
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Temperature'
              }
            }]
          }
        }
      });
    }).catch(err => console.error(err))
  </script>
</body>

</html>